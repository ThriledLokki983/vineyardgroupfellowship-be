services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["./start.sh"]
    container_name: vineyard-group-fellowship-web

    depends_on:
      pgbouncer:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    environment:
      ALLOWED_HOSTS: localhost,127.0.0.1,0.0.0.0,web
      CELERY_BROKER_URL: redis://:redis_dev_password@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:redis_dev_password@redis:6379/0
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://127.0.0.1:3000,http://localhost:8002,http://127.0.0.1:8002
      CSRF_TRUSTED_ORIGINS: http://localhost:3000,http://127.0.0.1:3000,http://localhost:8002,http://127.0.0.1:8002
      DB_HOST: pgbouncer
      DB_NAME: vineyard_group_fellowship_dev
      DB_PASSWORD: vineyard_group_fellowship_dev_password
      DB_PORT: "5432"
      DB_USER: vineyard_group_fellowship
      DEBUG: "True"  # you can flip this to "False" later
      DEFAULT_FROM_EMAIL: Vineyard Group Fellowship <noreply@vineyardgroupfellowship.org>
      DJANGO_ENVIRONMENT: production
      EMAIL_BACKEND: core.email_backends.SendGridWebAPIBackend
      ENABLE_DEBUG_TOOLBAR: "true"
      ENABLE_PERFORMANCE_MONITORING: "true"
      ENABLE_SILK_PROFILING: "false"
      LOG_LEVEL: DEBUG
      MONITORING_SAMPLE_RATE: "1.0"
      PORT: "8002"
      PYTHONDONTWRITEBYTECODE: "1"
      PYTHONUNBUFFERED: "1"
      REDIS_PASSWORD: redis_dev_password
      REDIS_URL: redis://:redis_dev_password@redis:6379/1
      SECRET_KEY: django-insecure-development-key-change-in-production
      SERVER_PORT: "8002"
      STRUCTURED_LOGGING: "true"
      USE_MAILHOG: "true"
      WATCHFILES_FORCE_POLLING: "true"

    networks:
      vineyard_network: null

    ports:
      - "8002:8002"

    restart: unless-stopped
    stdin_open: true
    tty: true

    # ⬇️ IMPORTANT: only mount data/external dirs, NOT /app itself
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - logs_volume:/app/logs

volumes:
  static_volume:
  media_volume:
  logs_volume: