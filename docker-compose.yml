# Docker Compose configuration for Vineyard Group Fellowship Backend
# =================================================================
#
# This Docker Compose file sets up the complete development infrastructure
# including PostgreSQL database, Redis cache, and MailHog for email testing.
#
# Setup Instructions:
# 1. Copy .env.docker.example to .env.docker
# 2. Update credentials in .env.docker (never use example passwords!)
# 3. Run: docker-compose up -d
#
# Services:
# - web: Django application (built from current directory)
# - postgres: PostgreSQL 15 database
# - redis: Redis 7 for caching and rate limiting
# - mailhog: Email testing service with web UI
#
# Usage:
#   docker-compose up -d                    # Start all services in background
#   docker-compose up web                   # Start with web service in foreground
#   docker-compose down                     # Stop all services
#   docker-compose logs -f web              # Follow web service logs
#
# Note: This configuration includes development-friendly defaults.
# For production, use a separate docker-compose.prod.yml file.

# Project name configuration
name: vineyard-group-fellowship

services:
  # PostgreSQL Database with PostGIS
  postgres:
    image: imresamu/postgis:16-3.4.4-alpine3.22
    container_name: vineyard-group-fellowship-postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-vineyard_group_fellowship}
      POSTGRES_USER: ${DB_USER:-vineyard_group_fellowship}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-vineyard_group_fellowship}
      # Increase max_connections to support PgBouncer
      POSTGRES_INITDB_ARGS: "-c max_connections=200"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2621kB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-vineyard_group_fellowship} -d ${DB_NAME:-vineyard_group_fellowship}"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - vineyard_network

  # PgBouncer - Connection Pooler for PostgreSQL
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: vineyard-group-fellowship-pgbouncer
    environment:
      DATABASE_URL: "postgres://${DB_USER:-vineyard_group_fellowship}:${DB_PASSWORD:-vineyard_group_fellowship}@postgres:5432/${DB_NAME:-vineyard_group_fellowship}"
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 20
      RESERVE_POOL_SIZE: 5
      MAX_DB_CONNECTIONS: 50
    ports:
      - "6432:5432"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep pgbouncer || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - vineyard_network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: vineyard-group-fellowship-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-redis_password}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - vineyard_network

  # MailHog for development email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: vineyard-group-fellowship-mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web interface
    networks:
      - vineyard_network
    profiles: ["development"]

  # Django Application (for full containerized development)
  web:
    build: .
    container_name: vineyard-group-fellowship-web
    command: ./start.sh
    env_file:
      - .env.docker  # Load environment variables from .env.docker file
    volumes:
      - .:/app
      - /app/.venv  # Exclude venv from volume mount for performance
      - /app/node_modules  # Exclude node_modules if any
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "${SERVER_PORT:-8002}:${SERVER_PORT:-8002}"
    environment:
      # Override specific settings for Docker environment
      - PYTHONUNBUFFERED=1  # Ensures Python output is sent straight to terminal
      - WATCHFILES_FORCE_POLLING=true  # Force polling for file changes
      - PORT=${SERVER_PORT:-8002}  # Map SERVER_PORT to PORT for start.sh script
      # Connect to PgBouncer instead of PostgreSQL directly
      - DB_HOST=pgbouncer
      - DB_PORT=5432
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vineyard_network
    # Enable development features
    stdin_open: true
    tty: true
    # Restart policy for development
    restart: unless-stopped

  # Celery Worker for background tasks
  celery:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: development
    container_name: vineyard-group-fellowship-celery
    command: bash -c "source /app/venv/bin/activate && celery -A vineyard_group_fellowship worker --loglevel=info"
    env_file:
      - .env.docker
    volumes:
      - .:/app
      - /app/.venv
      - media_volume:/app/media
    environment:
      - PYTHONUNBUFFERED=1
      # Connect to PgBouncer instead of PostgreSQL directly
      - DB_HOST=pgbouncer
      - DB_PORT=5432
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - vineyard_network
    restart: unless-stopped

  # Celery Beat for scheduled tasks
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: development
    container_name: vineyard-group-fellowship-celery-beat
    command: bash -c "source /app/venv/bin/activate && celery -A vineyard_group_fellowship beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler"
    env_file:
      - .env.docker
    volumes:
      - .:/app
      - /app/.venv
    environment:
      - PYTHONUNBUFFERED=1
      # Connect to PgBouncer instead of PostgreSQL directly
      - DB_HOST=pgbouncer
      - DB_PORT=5432
    depends_on:
      postgres:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    networks:
      - vineyard_network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  static_volume:
  media_volume:

networks:
  vineyard_network:
    driver: bridge